<!doctype html>
<html>
<head>
    <title>Cat Detector</title>
    <style>
    table, table td {
        border: 1px solid #ccc;
        border-collapse: collapse;
    }
    table td {
        text-align: center;
        width: 3%;
    }
    #images img {
        height: 150px;
        border: 2px solid gray;
        margin-right: 5px;
    }
    #images img.cat {
        border: 2px solid green;
    }
    </style>
</head>
<body>

    <div id="images"></div>
    <div id="results"></div>
    <div id="status"></div>
    <table>
        <thead>
            <tr>
                <th>operation</th>
                <th>duration (ms)</th>
            </tr>
        </thead>
        <tbody id="times">
        </tbody>
    </table>
<!-- Load TensorFlow.js. This is required to use MobileNet. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.1"> </script>
<!-- Load the MobileNet model. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@1.0.0"> </script>
<script src="parallel.js"></script>
<script>

let recordedTimes = [];
function recordTimeStart(activityName) {
    recordedTimes[activityName] = {
        "start": new Date().getTime()
    };
    const tableRow = document.createElement("tr");
    const operationTd = document.createElement("td");
    const durationTd = document.createElement("td");
    operationTd.innerText = activityName;
    durationTd.innerText = "(in progress)";
    tableRow.appendChild(operationTd);
    tableRow.appendChild(durationTd);
    document.getElementById("times").appendChild(tableRow);
};

function recordTimeEnd(activityName) {
    recordedTimes[activityName]["end"] = new Date().getTime();
    recordedTimes[activityName]["duration"] = recordedTimes[activityName]["end"] - recordedTimes[activityName]["start"];
    var timesTbody = document.getElementById("times");
    const tableRow = document.createElement("tr");
    const operationTd = document.createElement("td");
    const durationTd = document.createElement("td");
    operationTd.innerText = activityName;
    durationTd.innerText = recordedTimes[activityName]["duration"];
    tableRow.appendChild(operationTd);
    tableRow.appendChild(durationTd);
    timesTbody.removeChild(timesTbody.lastChild);
    timesTbody.appendChild(tableRow);
};

function detectCat(model, img) {
    return new Promise((resolve, reject) => {
        return model.classify(img).then(predictions => {
            predictions.forEach((prediction) => {
                const classes = prediction.className.split(",");
                let foundCat = false;
                classes.forEach((predictionClass) => {
                    if (predictionClass.endsWith("cat")) {
                        img.classList.add("cat");
                        foundCat = true;
                    }
                });
                resolve(foundCat);
            })
        }).catch(e => {
            reject(e);
        });
    });
};

const imageNames = ["butterfly.png", "crocodiles.png", "dogs_collies.png", "cat.png"];
const imageNodes = [];

recordTimeStart("loading images");
const imagesDiv = document.getElementById("images");
imageNames.forEach((imageName) => {
    const imageNode = document.createElement("img");
    imageNode.src = "images/" + imageName;
    imagesDiv.appendChild(imageNode);
    imageNodes.push(imageNode);
});
recordTimeEnd("loading images");

recordTimeStart("loading machine learning model");
mobilenet.load().then(model => {
    recordTimeEnd("loading machine learning model");
    recordTimeStart("detecting cats");
    let imagesProcessed = 0;
    let numCats = 0;
    imageNodes.forEach((image) => {
        detectCat(model, image).then(foundCat => {
            imagesProcessed++;
            if (foundCat) {
                numCats++;
            }
            if (imagesProcessed === imageNodes.length) {
                recordTimeEnd("detecting cats");
                console.log(recordedTimes);
            }
        });
    });
});


</script>
</body>
</html>